#!/usr/bin/env bash
set -euo pipefail

BASE_URL="https://backloggd.com"
SERVICE="backloggd"

need_bin() { command -v "$1" >/dev/null 2>&1 || { echo "Falta binario: $1" >&2; exit 1; }; }
need_bin curl
need_bin security
need_bin python3

kc() {
  local account="$1"
  security find-generic-password -s "$SERVICE" -a "$account" -w 2>/dev/null || true
}

USERNAME="$(kc username)"
CSRF="$(kc csrf_token)"
COOKIE="$(kc cookie_header)"

auth_headers=(
  -H "X-CSRF-Token: ${CSRF}"
  -H "Cookie: ${COOKIE}"
  -H "X-Requested-With: XMLHttpRequest"
  -H "Accept: application/json, text/javascript, */*; q=0.01"
  -H "Content-Type: application/x-www-form-urlencoded; charset=UTF-8"
)

require_auth() {
  if [[ -z "${CSRF}" || -z "${COOKIE}" ]]; then
    echo "Faltan csrf_token/cookie_header en keychain (servicio backloggd)." >&2
    exit 1
  fi
}

api_call() {
  local method="$1" endpoint="$2" data="${3:-}"
  require_auth
  if [[ -n "$data" ]]; then
    curl -s -X "$method" "${BASE_URL}${endpoint}" "${auth_headers[@]}" --data "$data"
  else
    curl -s -X "$method" "${BASE_URL}${endpoint}" "${auth_headers[@]}"
  fi
}

usage() {
  cat <<'EOF'
backloggd-mini (bash)

Uso:
  backloggd-mini backlog [--sort campo] [--asc|--desc]

  backloggd-mini log <game_id> <wishlist|backlog|playing|play>
  backloggd-mini unlog <game_id>
  backloggd-mini set-status <game_id> <status_id>
  backloggd-mini rate <game_id> <rating>
  backloggd-mini unrate <game_id>

  backloggd-mini list-add <game_id> <list_ids_csv>
  backloggd-mini list-create <name>
  backloggd-mini list-update <list_id> <name>
  backloggd-mini list-delete <list_id>
  backloggd-mini list-stats <list_id>

  backloggd-mini folder-create <name>
  backloggd-mini folder-delete <folder_id>
  backloggd-mini folder-assign <folder_id> <list_ids_csv>

  backloggd-mini like-review <review_id>
  backloggd-mini unlike-review <review_id>
  backloggd-mini comment-add <review_id> <texto>
  backloggd-mini comment-edit <comment_id> <texto>
  backloggd-mini comment-delete <comment_id>
  backloggd-mini report <review_id> <reason>

  backloggd-mini help

Sort campos t√≠picos:
  release, title, added, rating, user-rating, popular, trending,
  time, avg-play-time, avg-finish-time, last_played, shuffle

Status IDs:
  0=Completed, 2=Abandoned, 3=Retired, 4=Shelved, 5=Played
EOF
}

csv_to_repeat() {
  local key="$1" csv="$2" out=""
  IFS=',' read -r -a ids <<< "$csv"
  for id in "${ids[@]}"; do
    [[ -n "$id" ]] && out+="${key}[]=${id}&"
  done
  echo "${out%&}"
}

cmd_backlog() {
  local sort="release" dir="asc"
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --sort) sort="${2:-release}"; shift 2 ;;
      --asc) dir="asc"; shift ;;
      --desc) dir="desc"; shift ;;
      *) echo "Arg no reconocido: $1" >&2; exit 1 ;;
    esac
  done

  [[ -z "${USERNAME}" ]] && { echo "Falta username en keychain (backloggd/username)." >&2; exit 1; }

  local path="/u/${USERNAME}/backlog/${sort}/"
  [[ "$dir" == "asc" ]] && path="/u/${USERNAME}/backlog/${sort}:asc/"

  python3 - "${BASE_URL}${path}" <<'PY'
import sys,re,html,urllib.request
url=sys.argv[1]
src=urllib.request.urlopen(url, timeout=30).read().decode('utf-8','ignore')
pat=re.compile(r'<div class="card mx-auto game-cover [^"]*"[^>]*>.*?<img[^>]*alt="([^"]+)".*?</div>\s*</div>\s*<div class="row mx-0 release-below">\s*<p>([^<]+)</p>',re.S)
rows=[]
seen=set()
for t,d in pat.findall(src):
    title=html.unescape(t).strip()
    date=html.unescape(d).strip()
    if title in seen: continue
    seen.add(title)
    rows.append((date,title))
for date,title in rows:
    print(f"{date}\t{title}")
PY
}

cmd_log() {
  local game_id="${1:-}" kind="${2:-}"
  [[ -z "$game_id" || -z "$kind" ]] && { usage; exit 1; }
  api_call POST "/log/" "type=${kind}&game_id=${game_id}"; echo
}

cmd_unlog() {
  local game_id="${1:-}"
  [[ -z "$game_id" ]] && { usage; exit 1; }
  api_call DELETE "/unlog/" "game_id=${game_id}"; echo
}

cmd_set_status() {
  local game_id="${1:-}" status_id="${2:-}"
  [[ -z "$game_id" || -z "$status_id" ]] && { usage; exit 1; }
  api_call PATCH "/log/status/" "game_id=${game_id}&status_id=${status_id}"; echo
}

cmd_rate() {
  local game_id="${1:-}" rating="${2:-}"
  [[ -z "$game_id" || -z "$rating" ]] && { usage; exit 1; }
  api_call POST "/rate/${game_id}" "rating=${rating}"; echo
}

cmd_unrate() {
  local game_id="${1:-}"
  [[ -z "$game_id" ]] && { usage; exit 1; }
  api_call DELETE "/delete-rating/" "game_id=${game_id}"; echo
}

cmd_list_add() {
  local game_id="${1:-}" csv="${2:-}"
  [[ -z "$game_id" || -z "$csv" ]] && { usage; exit 1; }
  local data
  data="$(csv_to_repeat list_ids "$csv")"
  api_call POST "/api/list/quick/${game_id}" "$data"; echo
}

cmd_list_create() {
  local name="${1:-}"
  [[ -z "$name" ]] && { usage; exit 1; }
  api_call POST "/api/new-list/" "name=${name}"; echo
}

cmd_list_update() {
  local list_id="${1:-}" name="${2:-}"
  [[ -z "$list_id" || -z "$name" ]] && { usage; exit 1; }
  api_call PUT "/api/list/" "list_id=${list_id}&name=${name}"; echo
}

cmd_list_delete() {
  local list_id="${1:-}"
  [[ -z "$list_id" ]] && { usage; exit 1; }
  api_call DELETE "/api/list/" "list_id=${list_id}"; echo
}

cmd_list_stats() {
  local list_id="${1:-}"
  [[ -z "$list_id" ]] && { usage; exit 1; }
  api_call PUT "/api/list/stats/" "list_id=${list_id}"; echo
}

cmd_folder_create() {
  local name="${1:-}"
  [[ -z "$name" ]] && { usage; exit 1; }
  api_call POST "/api/list/folder" "name=${name}"; echo
}

cmd_folder_delete() {
  local folder_id="${1:-}"
  [[ -z "$folder_id" ]] && { usage; exit 1; }
  api_call DELETE "/api/list/folder" "folder_id=${folder_id}"; echo
}

cmd_folder_assign() {
  local folder_id="${1:-}" csv="${2:-}"
  [[ -z "$folder_id" || -z "$csv" ]] && { usage; exit 1; }
  local data
  data="folder_id=${folder_id}&$(csv_to_repeat list_ids "$csv")"
  api_call PUT "/api/list/folder/lists/" "$data"; echo
}

cmd_like_review() {
  local review_id="${1:-}"
  [[ -z "$review_id" ]] && { usage; exit 1; }
  api_call POST "/like/" "id=${review_id}"; echo
}

cmd_unlike_review() {
  local review_id="${1:-}"
  [[ -z "$review_id" ]] && { usage; exit 1; }
  api_call DELETE "/unlike/" "id=${review_id}"; echo
}

cmd_comment_add() {
  local review_id="${1:-}" text="${2:-}"
  [[ -z "$review_id" || -z "$text" ]] && { usage; exit 1; }
  api_call POST "/comment/" "id=${review_id}&content=${text}"; echo
}

cmd_comment_edit() {
  local comment_id="${1:-}" text="${2:-}"
  [[ -z "$comment_id" || -z "$text" ]] && { usage; exit 1; }
  api_call POST "/comment/edit/" "comment_id=${comment_id}&content=${text}"; echo
}

cmd_comment_delete() {
  local comment_id="${1:-}"
  [[ -z "$comment_id" ]] && { usage; exit 1; }
  api_call DELETE "/comment/destroy/" "comment_id=${comment_id}"; echo
}

cmd_report() {
  local review_id="${1:-}" reason="${2:-}"
  [[ -z "$review_id" || -z "$reason" ]] && { usage; exit 1; }
  api_call POST "/report/" "id=${review_id}&reason=${reason}"; echo
}

main() {
  local cmd="${1:-help}"; shift || true
  case "$cmd" in
    backlog) cmd_backlog "$@" ;;
    log) cmd_log "$@" ;;
    unlog) cmd_unlog "$@" ;;
    set-status) cmd_set_status "$@" ;;
    rate) cmd_rate "$@" ;;
    unrate) cmd_unrate "$@" ;;

    list-add) cmd_list_add "$@" ;;
    list-create) cmd_list_create "$@" ;;
    list-update) cmd_list_update "$@" ;;
    list-delete) cmd_list_delete "$@" ;;
    list-stats) cmd_list_stats "$@" ;;

    folder-create) cmd_folder_create "$@" ;;
    folder-delete) cmd_folder_delete "$@" ;;
    folder-assign) cmd_folder_assign "$@" ;;

    like-review) cmd_like_review "$@" ;;
    unlike-review) cmd_unlike_review "$@" ;;
    comment-add) cmd_comment_add "$@" ;;
    comment-edit) cmd_comment_edit "$@" ;;
    comment-delete) cmd_comment_delete "$@" ;;
    report) cmd_report "$@" ;;

    help|-h|--help) usage ;;
    *) echo "Comando desconocido: $cmd" >&2; usage; exit 1 ;;
  esac
}

main "$@"
