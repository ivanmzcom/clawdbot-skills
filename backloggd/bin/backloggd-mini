#!/usr/bin/env bash
set -euo pipefail

BASE_URL="${BACKLOGGD_MINI_BASE_URL:-https://backloggd.com}"
SERVICE="${BACKLOGGD_MINI_SERVICE:-backloggd}"
DRY_RUN="${BACKLOGGD_MINI_DRY_RUN:-0}"

need_bin() { command -v "$1" >/dev/null 2>&1 || { echo "Falta binario: $1" >&2; exit 1; }; }
need_bin curl; need_bin security; need_bin python3

kc() { security find-generic-password -s "$SERVICE" -a "$1" -w 2>/dev/null || true; }
urlencode() { python3 -c 'import urllib.parse,sys;print(urllib.parse.quote(sys.argv[1],safe=""))' "$1"; }

USERNAME="$(kc username)"
CSRF="$(kc csrf_token)"
COOKIE="$(kc cookie_header)"

auth_headers=(
  -H "X-CSRF-Token: ${CSRF}"
  -H "Cookie: ${COOKIE}"
  -H "X-Requested-With: XMLHttpRequest"
  -H "Accept: application/json, text/javascript, */*; q=0.01"
  -H "Content-Type: application/x-www-form-urlencoded; charset=UTF-8"
)

require_auth() {
  [[ "$DRY_RUN" == "1" ]] && return 0
  if [[ -z "${CSRF}" || -z "${COOKIE}" ]]; then
    echo "Faltan csrf_token/cookie_header en keychain (servicio ${SERVICE})." >&2
    exit 1
  fi
}

api_call() {
  local method="$1" endpoint="$2" data="${3:-}"
  require_auth
  if [[ "$DRY_RUN" == "1" ]]; then
    echo "[DRY-RUN] $method ${BASE_URL}${endpoint}"
    [[ -n "$data" ]] && echo "[DRY-RUN] data: $data"
    return 0
  fi
  local resp status body
  if [[ -n "$data" ]]; then
    resp=$(curl -sS -X "$method" "${BASE_URL}${endpoint}" "${auth_headers[@]}" --data "$data" -w $'\n__STATUS__:%{http_code}')
  else
    resp=$(curl -sS -X "$method" "${BASE_URL}${endpoint}" "${auth_headers[@]}" -w $'\n__STATUS__:%{http_code}')
  fi
  status=$(printf '%s' "$resp" | awk -F: '/__STATUS__/{print $2}' | tail -1)
  body=$(printf '%s' "$resp" | sed '/__STATUS__:/d')
  printf '%s\n' "$body"
  if [[ -z "$status" || "$status" -ge 400 ]]; then
    echo "ERROR HTTP ${status:-unknown} en ${endpoint}" >&2
    return 1
  fi
}

usage() {
  cat <<'EOF'
backloggd-mini (bash)

Uso:
  backloggd-mini backlog [--sort campo] [--asc|--desc]

  backloggd-mini log <game_id> <wishlist|backlog|playing|play>
  backloggd-mini unlog <game_id>
  backloggd-mini set-status <game_id> <status_id>
  backloggd-mini rate <game_id> <rating>
  backloggd-mini unrate <game_id>

  backloggd-mini list-add <game_id> <list_ids_csv>
  backloggd-mini list-create <name>
  backloggd-mini list-update <list_id> <name>
  backloggd-mini list-delete <list_id>
  backloggd-mini list-stats <list_id>

  backloggd-mini folder-create <name>
  backloggd-mini folder-delete <folder_id>
  backloggd-mini folder-assign <folder_id> <list_ids_csv>

  backloggd-mini like-review <review_id>
  backloggd-mini unlike-review <review_id>
  backloggd-mini comment-add <review_id> <texto>
  backloggd-mini comment-edit <comment_id> <texto>
  backloggd-mini comment-delete <comment_id>
  backloggd-mini report <review_id> <reason>

  backloggd-mini help

Env:
  BACKLOGGD_MINI_DRY_RUN=1      No ejecuta mutaciones, imprime request
  BACKLOGGD_MINI_BASE_URL=...   Override host

Status IDs: 0=Completed, 2=Abandoned, 3=Retired, 4=Shelved, 5=Played
EOF
}

csv_to_repeat() {
  local key="$1" csv="$2" out=""
  IFS=',' read -r -a ids <<< "$csv"
  for id in "${ids[@]}"; do
    id="${id// /}"
    [[ -n "$id" ]] && out+="${key}[]=$(urlencode "$id")&"
  done
  echo "${out%&}"
}

kv() { printf '%s=%s' "$1" "$(urlencode "$2")"; }

cmd_backlog() {
  local sort="release" dir="asc"
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --sort) sort="${2:-release}"; shift 2 ;;
      --asc) dir="asc"; shift ;;
      --desc) dir="desc"; shift ;;
      *) echo "Arg no reconocido: $1" >&2; exit 1 ;;
    esac
  done
  [[ -z "${USERNAME}" ]] && { echo "Falta username en keychain (${SERVICE}/username)." >&2; exit 1; }
  local path="/u/${USERNAME}/backlog/${sort}/"; [[ "$dir" == "asc" ]] && path="/u/${USERNAME}/backlog/${sort}:asc/"

  python3 - "${BASE_URL}${path}" <<'PY'
import sys,re,html,urllib.request
src=urllib.request.urlopen(sys.argv[1], timeout=30).read().decode('utf-8','ignore')
pat=re.compile(r'<div class="card mx-auto game-cover [^"]*"[^>]*>.*?<img[^>]*alt="([^"]+)".*?</div>\s*</div>\s*<div class="row mx-0 release-below">\s*<p>([^<]+)</p>',re.S)
seen=set()
for t,d in pat.findall(src):
    title=html.unescape(t).strip(); date=html.unescape(d).strip()
    if title in seen: continue
    seen.add(title)
    print(f"{date}\t{title}")
PY
}

cmd_log(){ [[ $# -lt 2 ]]&&{ usage; exit 1; }; api_call POST "/log/" "$(kv type "$2")&$(kv game_id "$1")"; }
cmd_unlog(){ [[ $# -lt 1 ]]&&{ usage; exit 1; }; api_call DELETE "/unlog/" "$(kv game_id "$1")"; }
cmd_set_status(){ [[ $# -lt 2 ]]&&{ usage; exit 1; }; api_call PATCH "/log/status/" "$(kv game_id "$1")&$(kv status_id "$2")"; }
cmd_rate(){ [[ $# -lt 2 ]]&&{ usage; exit 1; }; api_call POST "/rate/$1" "$(kv rating "$2")"; }
cmd_unrate(){ [[ $# -lt 1 ]]&&{ usage; exit 1; }; api_call DELETE "/delete-rating/" "$(kv game_id "$1")"; }

cmd_list_add(){ [[ $# -lt 2 ]]&&{ usage; exit 1; }; api_call POST "/api/list/quick/$1" "$(csv_to_repeat list_ids "$2")"; }
cmd_list_create(){
  [[ $# -lt 1 ]]&&{ usage; exit 1; }
  local name="$1"
  require_auth

  if [[ "$DRY_RUN" == "1" ]]; then
    echo "[DRY-RUN] POST ${BASE_URL}/api/new-list/"
    echo "[DRY-RUN] GET  <new_url> (parse list_id from .list-form#id)"
    echo "[DRY-RUN] PUT  ${BASE_URL}/api/list/ data: $(kv list_id "<parsed>")&$(kv name "$name")"
    return 0
  fi

  local resp status body new_url edit_html list_id
  resp=$(curl -sS -X POST "${BASE_URL}/api/new-list/" "${auth_headers[@]}" -w $'\n__STATUS__:%{http_code}')
  status=$(printf '%s' "$resp" | awk -F: '/__STATUS__/{print $2}' | tail -1)
  body=$(printf '%s' "$resp" | sed '/__STATUS__:/d')
  if [[ -z "$status" || "$status" -ge 400 ]]; then
    echo "ERROR HTTP ${status:-unknown} en /api/new-list/" >&2
    return 1
  fi

  new_url=$(python3 - <<'PY' "$body"
import json,sys
try:
    j=json.loads(sys.argv[1])
    print(j.get('new_url',''))
except Exception:
    print('')
PY
)
  [[ -z "$new_url" ]] && { echo "ERROR: /api/new-list/ no devolviÃ³ new_url" >&2; return 1; }

  edit_html=$(curl -sS "${BASE_URL}${new_url}" -H "Cookie: ${COOKIE}")
  list_id=$(python3 - <<'PY' "$edit_html"
import re,sys
h=sys.argv[1]
m=re.search(r'class="list-form"[^>]*\sid="([^"]+)"', h)
if not m:
    m=re.search(r'id="([^"]+)"[^>]*class="list-form"', h)
print(m.group(1) if m else '')
PY
)
  [[ -z "$list_id" ]] && { echo "ERROR: no pude extraer list_id desde ${new_url}" >&2; return 1; }

  api_call PUT "/api/list/" "$(kv list_id "$list_id")&$(kv name "$name")"
}
cmd_list_update(){ [[ $# -lt 2 ]]&&{ usage; exit 1; }; api_call PUT "/api/list/" "$(kv list_id "$1")&$(kv name "$2")"; }
cmd_list_delete(){ [[ $# -lt 1 ]]&&{ usage; exit 1; }; api_call DELETE "/api/list/" "$(kv list_id "$1")"; }
cmd_list_stats(){ [[ $# -lt 1 ]]&&{ usage; exit 1; }; api_call PUT "/api/list/stats/" "$(kv list_id "$1")"; }

cmd_folder_create(){ [[ $# -lt 1 ]]&&{ usage; exit 1; }; api_call POST "/api/list/folder" "$(kv name "$1")"; }
cmd_folder_delete(){ [[ $# -lt 1 ]]&&{ usage; exit 1; }; api_call DELETE "/api/list/folder" "$(kv folder_id "$1")"; }
cmd_folder_assign(){ [[ $# -lt 2 ]]&&{ usage; exit 1; }; api_call PUT "/api/list/folder/lists/" "$(kv folder_id "$1")&$(csv_to_repeat list_ids "$2")"; }

cmd_like_review(){ [[ $# -lt 1 ]]&&{ usage; exit 1; }; api_call POST "/like/" "$(kv id "$1")"; }
cmd_unlike_review(){ [[ $# -lt 1 ]]&&{ usage; exit 1; }; api_call DELETE "/unlike/" "$(kv id "$1")"; }
cmd_comment_add(){ [[ $# -lt 2 ]]&&{ usage; exit 1; }; api_call POST "/comment/" "$(kv id "$1")&$(kv content "$2")"; }
cmd_comment_edit(){ [[ $# -lt 2 ]]&&{ usage; exit 1; }; api_call POST "/comment/edit/" "$(kv comment_id "$1")&$(kv content "$2")"; }
cmd_comment_delete(){ [[ $# -lt 1 ]]&&{ usage; exit 1; }; api_call DELETE "/comment/destroy/" "$(kv comment_id "$1")"; }
cmd_report(){ [[ $# -lt 2 ]]&&{ usage; exit 1; }; api_call POST "/report/" "$(kv id "$1")&$(kv reason "$2")"; }

main(){
  local cmd="${1:-help}"; shift || true
  case "$cmd" in
    backlog) cmd_backlog "$@" ;;
    log) cmd_log "$@" ;;
    unlog) cmd_unlog "$@" ;;
    set-status) cmd_set_status "$@" ;;
    rate) cmd_rate "$@" ;;
    unrate) cmd_unrate "$@" ;;
    list-add) cmd_list_add "$@" ;;
    list-create) cmd_list_create "$@" ;;
    list-update) cmd_list_update "$@" ;;
    list-delete) cmd_list_delete "$@" ;;
    list-stats) cmd_list_stats "$@" ;;
    folder-create) cmd_folder_create "$@" ;;
    folder-delete) cmd_folder_delete "$@" ;;
    folder-assign) cmd_folder_assign "$@" ;;
    like-review) cmd_like_review "$@" ;;
    unlike-review) cmd_unlike_review "$@" ;;
    comment-add) cmd_comment_add "$@" ;;
    comment-edit) cmd_comment_edit "$@" ;;
    comment-delete) cmd_comment_delete "$@" ;;
    report) cmd_report "$@" ;;
    help|-h|--help) usage ;;
    *) echo "Comando desconocido: $cmd" >&2; usage; exit 1 ;;
  esac
}

main "$@"
